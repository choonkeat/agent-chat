{{- define "format-messages" -}}
{{- range $i, $m := .Messages -}}
{{- if $i}}

{{end -}}
{{- if $m.IsVoice -}}
Decoded user's speech to text (may be inaccurate): {{$m.Text}}

IMPORTANT: Confirm your understanding with the user before taking action. Present a brief summary of what you understood and ask the user to confirm yes or no before proceeding.
{{- else -}}
{{- $m.Text -}}
{{- end -}}
{{- end -}}
{{- if .Files}}

Attached files:
{{- range .Files}}
  {{.Path}} ({{.Type}}, {{.Size}})
{{- end -}}
{{- end -}}
{{- end}}


{{- define "reply-instructions" -}}
{{- if .IsVoice -}}
User can only hear you now; keep it conversational, no markdown.
IMPORTANT: Never put more than one question in a single message. Wait for the answer before asking the next question.

{{end -}}
Before taking any action, ensure mutual understanding:
- You and the user must agree on what will be done and what effect it will have.
- Confirm your understanding. Verify the user understands the impact.
- Get explicit "yes" before proceeding.
- {{ if .IsVoice -}}send_verbal_progress{{ else }}send_progress{{ end }} before proceeding

When doing tasks
- call check_messages between steps.

User cannot see TUI â€” never ask questions there. {{ if .IsVoice -}}send_verbal_reply{{ else }}send_message{{ end }} to wait for further instructions. {{ if .IsVoice -}}send_verbal_progress{{ else }}send_progress{{ end }} for non-blocking updates.
{{- end}}
